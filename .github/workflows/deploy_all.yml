name: Deploy Full CyRide System

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  deploy-and-restart:
    runs-on: self-hosted
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: 1. Install System Dependencies
      run: |
        echo "Installing ffmpeg and python tools..."
        sudo apt-get update -qq
        sudo apt-get install -y ffmpeg python3-pip python3-venv

    - name: 2. Install Python Requirements
      run: |
        echo "Installing Python libraries..."
        sudo /usr/bin/python3 -m pip install -r requirements.txt

    - name: 3. Setup Directories (Base Only)
      run: |
        USER_NAME=$(whoami)
        BASE_DATA_DIR="/home/$USER_NAME/CYRIDE"
        APP_DIR=$(pwd)
        
        # We only create the Base folder. 
        # WE DO NOT create subfolders (states, Location, etc) because that blocks the Google Drive mount.
        echo "Ensuring base directory exists at $BASE_DATA_DIR..."
        mkdir -p "$BASE_DATA_DIR"

        echo "Fixing permissions for $USER_NAME..."
        # sudo chown -R $USER_NAME:$USER_NAME "$BASE_DATA_DIR"
        # sudo chown -R $USER_NAME:$USER_NAME "$APP_DIR"

    - name: 4. Create and Register Services
      run: |
        APP_DIR=$(pwd)
        USER_NAME=$(whoami)
        BASE_DATA_DIR="/home/$USER_NAME/CYRIDE"
        
        echo "Generating Service Files for User: $USER_NAME"

        generate_service() {
            SERVICE_NAME=$1
            SCRIPT_FILE=$2
            DESC=$3
            CAPS=$4
            
            cat <<EOF > $SERVICE_NAME.service
        [Unit]
        Description=$DESC
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=simple
        User=$USER_NAME
        WorkingDirectory=$APP_DIR
        ExecStart=/usr/bin/python3 -u $APP_DIR/$SCRIPT_FILE
        Restart=always
        RestartSec=10
        Environment=CYRIDE_BASE_DIR=$BASE_DATA_DIR
        StandardOutput=journal
        StandardError=journal
        $CAPS

        [Install]
        WantedBy=multi-user.target
        EOF
            
            sudo mv $SERVICE_NAME.service /etc/systemd/system/
            sudo systemctl enable $SERVICE_NAME.service
        }

        generate_service "cyride-web" "scripts/simple_server.py" "CyRide Web Interface" "AmbientCapabilities=CAP_NET_BIND_SERVICE"
        generate_service "cyride-manager" "scripts/queue_manager.py" "CyRide Queue Manager" ""
        generate_service "cyride-transcriber" "scripts/transcription_worker.py" "CyRide Transcriber" ""
        generate_service "cyride-logger" "scripts/cymap_logger.py" "CyRide Location Logger" ""

    - name: 5. Restart All Services
      run: |
        echo "Reloading Systemd..."
        sudo systemctl daemon-reload
        sudo systemctl restart cyride-web
        sudo systemctl restart cyride-manager
        sudo systemctl restart cyride-transcriber
        sudo systemctl restart cyride-logger
        echo "DEPLOYMENT COMPLETE."
