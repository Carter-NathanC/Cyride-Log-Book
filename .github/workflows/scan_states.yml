name: Run State Scanner

on:
  workflow_dispatch: # Allows manual trigger button
    inputs:
      days:
        description: 'Number of past days to scan'
        required: false
        default: '3'
      date:
        description: 'Specific date (YYYY-MM-DD) - Overrides days'
        required: false
        
  schedule:
    - cron: '*/30 * * * *' # Run every 30 minutes automatically

jobs:
  scan:
    runs-on: self-hosted

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Environment
      run: |
        # Ensure directories exist
        mkdir -p /home/sdr/scripts
        
        # Copy scanner script from repo to local scripts folder
        # Assumes the file is at scripts/state_scanner.py in your repo
        cp scripts/state_scanner.py /home/sdr/scripts/
        chmod +x /home/sdr/scripts/state_scanner.py

    - name: Run Scanner
      run: |
        # Determine arguments
        DAYS="${{ github.event.inputs.days || '3' }}"
        DATE_ARG=""
        
        if [ ! -z "${{ github.event.inputs.date }}" ]; then
          DATE_ARG="--date ${{ github.event.inputs.date }}"
        fi
        
        echo "Running scanner with Days: $DAYS $DATE_ARG"
        
        # Run the python script directly using system python
        # We define the base directory env var to ensure it finds the mount
        export CYRIDE_BASE_DIR="/home/sdr/CYRIDE"
        /usr/bin/python3 /home/sdr/scripts/state_scanner.py --days $DAYS $DATE_ARG
